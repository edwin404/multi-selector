(function(){var e=function(e){if("undefined"==typeof $)return void alert("MultiSelector require jQuery");var t={container:null,seperator:",",dynamic:!1,server:"/path/to/data",data:[],maxLevel:0,fixedLevel:0,lang:{loading:"正在加载...",pleaseSelect:"请选择"},callback:{change:function(e,t){},done:function(){},close:function(){}},selectorValue:"[data-value]",selectorTitle:"[data-title]",selectorSelect:"[data-select]",valueKey:"id",parentValueKey:"pid",titleKey:"title",sortKey:"sort",rootParentValue:0,serverMethod:"get",serverDataType:"json",serverResponseHandle:function(e){return"object"!=typeof e?(alert("ErrorResponse:"+e),[]):"code"in e&&"data"in e?0!=e.code?(alert("ErrorResponseCode:"+e.code),[]):e.data:(alert("ErrorResponseObject:"+e.toString()),[])}};this.opt=$.extend(t,e);var i=this,n=$(this.opt.container),a=n.find(this.opt.selectorSelect);this.value=null,this.title=null,this.server=null,this.seperator=",",this.maxLevel=0,this.data=[],this.initValues=[],this.initTitles=[];var l=function(){s(),a.html(i.opt.lang.loading),i.opt.dynamic&&i.initValues.length?i.val(i.initValues):i.opt.dynamic&&i.initTitles.length?i.titleVal(i.initTitles):i.opt.dynamic?r(i.opt.rootParentValue,function(e){i.data=e,a.html(""),u(1,i.opt.rootParentValue),i.initValues.length?i.val(i.initValues):i.initTitles.length&&i.titleVal(i.initTitles)}):(i.data=o(i.opt.data),a.html(""),i.initValues.length?i.val(i.initValues):i.initTitles.length?i.titleVal(i.initTitles):u(1,i.opt.rootParentValue))},r=function(e,t,n){n=n||null;var a={},l=i.opt.sortKey;a[i.opt.parentValueKey]=e,a[i.opt.titleKey]=n,$.ajax({type:i.opt.serverMethod,url:i.opt.server,dataType:i.opt.serverDataType,timeout:3e4,data:a,success:function(e){var n=i.opt.serverResponseHandle(e);n.sort(function(e,t){return e[l]-t[l]});var a=o(e.data);t(a)},error:function(){alert("请求出现错误 T_T")}})},o=function(e){for(var t=[],n=0;n<e.length;n++)t.push({parentValue:e[n][i.opt.parentValueKey],value:e[n][i.opt.valueKey],title:e[n][i.opt.titleKey]});return t},s=function(){var e=n.find(i.opt.selectorValue).val(),t=n.find(i.opt.selectorTitle).val();if(e)for(var a=e.split(i.seperator),l=0;l<a.length;l++)a[l]&&i.initValues.push(a[l]);else if(t)for(var r=t.split(i.seperator),l=0;l<r.length;l++)r[l]&&i.initTitles.push(r[l])},u=function(e,t){for(var l=[],r=i.data,o=0;o<r.length;o++)r[o].parentValue==t&&l.push({value:r[o].value,title:r[o].title});if(a.find("select").each(function(t,i){var n=parseInt($(i).attr("data-level"));n>=e&&$(i).remove()}),l.length){var s=[];s.push('<select data-level="'+e+'" class="select">'),s.push('<option value="">'+i.opt.lang.pleaseSelect+"</option>");for(var o=0;o<l.length;o++)s.push('<option value="'+l[o].value+'">'+l[o].title+"</option>");s.push("</select>"),a.append(s.join("")),n.trigger("widget.category.rendered",[i])}},c=function(e){a.find("select").each(function(t,i){var n=parseInt($(i).attr("data-level"));n>=e&&$(i).remove()})},v=function(){n.find(i.opt.selectorValue).val(""),n.find(i.opt.selectorTitle).val("");var e=[],t=[];a.find("select").each(function(i,n){var a=$(n).val();a&&(e.push(a),t.push($(n).find("option:selected").text()))}),n.find(i.opt.selectorValue).each(function(t,n){var a=$(n).attr("data-level");a?(a=parseInt(a),a<=e.length&&$(n).val(e[a-1])):$(n).val(e.join(i.seperator))}),n.find(i.opt.selectorTitle).each(function(e,n){var a=$(n).attr("data-level");a?(a=parseInt(a),a<=t.length&&$(n).val(t[a-1])):$(n).val(t.join(i.seperator))}),i.value=e,i.title=t,n.trigger("widget.category.change",[i])};this.val=function(e){if(void 0==e)return i.value;if(i.initValues=e,!i.initValues.length)return void c(1);if(i.opt.dynamic)r(i.initValues.join(","),function(e){i.data=e,a.html(""),u(1,0);for(var t=0;t<i.initValues.length-1;t++){var n=t+2,l=i.initValues[t];(0==i.maxLevel||n<=i.maxLevel)&&u(n,l)}a.find("select").each(function(e,t){var n=$(t).attr("data-level");n&&(n=parseInt(n),n<=i.initValues.length&&$(t).val(i.initValues[n-1]))}),i.initValues=[],v()});else{u(1,i.opt.rootParentValue);for(var t=0;t<i.initValues.length;t++){var n=t+1,l=i.initValues[t],o=a.find("select");if(o.length>=n){var s=$(o.get(n-1));s.val(l).trigger("change")}}i.initValues=[]}},this.titleVal=function(e){if(void 0==e)return i.title;if(i.initTitles=e,!i.initTitles.length)return void c(1);if(i.opt.dynamic)r(null,function(e){i.data=e,a.html(""),u(1,0);for(var t=0;t<i.initTitles.length-1;t++){var n=t+2,l=i.initTitles[t],r=a.find("select[data-level="+(n-1)+"]"),o=null;r.find("option").each(function(e,t){$(t).text()==l&&(o=$(t).attr("value"))}),null!==o&&(0==i.maxLevel||n<=i.maxLevel)&&u(n,o)}a.find("select").each(function(e,t){var n=$(t).attr("data-level");if(n&&(n=parseInt(n),n<=i.initTitles.length)){var a=i.initTitles[n-1];$(t).find("option").each(function(e,t){$(t).text()==a&&$(t).prop("selected",!0)})}}),v()},i.initTitles.join(","));else{u(1,i.opt.rootParentValue);for(var t=0;t<i.initTitles.length;t++){var n=t+1,l=i.initTitles[t],o=a.find("select");if(o.length>=n){var s=$(o.get(n-1));s.find("option").each(function(e,t){$(t).text()==l&&s.val($(t).attr("value")).trigger("change")})}}}},a.on("change","select",function(){var e=parseInt($(this).attr("data-level")),t=$(this).val();return i.opt.dynamic?(0==i.maxLevel||e<i.maxLevel)&&(t>0?r(t,function(n){if(i.data=n,u(e+1,t),i.initValues&&i.initValues.length){var l=a.find("select");if(!l.length)return;var r=$(l.get(l.length-1));r.val(i.initValues.splice(0,1)[0]).trigger("change")}else if(i.initTitles&&i.initTitles.length){var l=a.find("select");if(!l.length)return;var r=$(l.get(l.length-1)),o=i.initTitles.splice(0,1)[0];r.find("option").each(function(e,t){$(t).text()==o&&r.val($(t).attr("value")).trigger("change")})}v()}):(c(e+1),v())):(0==i.maxLevel||e<i.maxLevel)&&(t>0?u(e+1,t):c(e+1),v()),!1}),l()};"undefined"!=typeof module&&"object"==typeof exports&&define.cmd?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):this.MultiSelector=e}).call(function(){return this||("undefined"!=typeof window?window:global)}());